<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sample Recorder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #18181b;
            --bg-elevated: #1f1f23;
            --bg-hover: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            --text-muted: #52525b;
            --accent-primary: #22d3ee;
            --accent-primary-dim: rgba(34, 211, 238, 0.15);
            --accent-success: #4ade80;
            --accent-success-dim: rgba(74, 222, 128, 0.15);
            --accent-warning: #fbbf24;
            --accent-warning-dim: rgba(251, 191, 36, 0.15);
            --accent-danger: #f87171;
            --accent-danger-dim: rgba(248, 113, 113, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-default: rgba(255, 255, 255, 0.1);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Outfit', -apple-system, sans-serif;
            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-primary);
        }
        .screen { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .screen.active { display: flex; }
        .header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            flex-shrink: 0;
        }
        .header-back {
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            background: transparent; border: none;
            color: var(--text-secondary);
            cursor: pointer; border-radius: var(--radius-sm);
            margin-right: 12px; transition: all 0.15s;
        }
        .header-back:hover { background: var(--bg-hover); color: var(--text-primary); }
        .header-title { flex: 1; font-size: 17px; font-weight: 600; letter-spacing: -0.02em; }
        .header-action {
            padding: 8px 14px; font-size: 13px; font-weight: 500;
            background: transparent; border: 1px solid var(--border-default);
            color: var(--text-secondary); border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.15s;
        }
        .header-action:hover { background: var(--bg-hover); color: var(--text-primary); }
        .content {
            flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px;
        }
        .content::-webkit-scrollbar { width: 6px; }
        .content::-webkit-scrollbar-track { background: transparent; }
        .content::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
        .recording-container {
            display: flex; flex-direction: column; height: 100%; padding: 24px 20px;
        }
        .recording-status { text-align: center; margin-bottom: 8px; }
        .status-indicator {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 6px 14px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .status-indicator.recording { background: var(--accent-danger-dim); color: var(--accent-danger); }
        .status-indicator.stopped { background: var(--accent-success-dim); color: var(--accent-success); }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: currentColor; animation: pulse 1.5s ease-in-out infinite;
        }
        .status-indicator.stopped .status-dot { animation: none; }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.85); }
        }
        .timer-display { text-align: center; padding: 32px 0; }
        .timer-value {
            font-family: var(--font-mono); font-size: 64px; font-weight: 700;
            letter-spacing: -0.03em; color: var(--text-primary); line-height: 1;
        }
        .timer-value.recording { color: var(--accent-primary); text-shadow: 0 0 60px rgba(34, 211, 238, 0.4); }
        .timer-subtitle { font-size: 13px; color: var(--text-tertiary); margin-top: 8px; font-family: var(--font-mono); }
        .route-section {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg); padding: 16px; margin-bottom: 16px;
        }
        .route-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .route-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-tertiary); }
        .route-confidence { font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        .route-display { display: flex; align-items: center; gap: 12px; }
        .route-point { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .route-icon {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            background: var(--bg-tertiary); border-radius: var(--radius-md); font-size: 18px;
        }
        .route-name { font-size: 12px; font-weight: 500; color: var(--text-secondary); }
        .route-arrow { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
        .route-arrow svg { width: 24px; height: 24px; }
        .route-override { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle); }
        .route-override-btn {
            width: 100%; padding: 10px; font-size: 13px; font-weight: 500;
            background: transparent; border: 1px dashed var(--border-default);
            color: var(--text-tertiary); border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.15s;
        }
        .route-override-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); background: var(--accent-primary-dim); }
        .data-card {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg); padding: 16px; margin-bottom: 12px;
        }
        .data-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .data-card-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-tertiary); }
        .data-card-status { font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 10px; }
        .data-card-status.pending { background: var(--bg-tertiary); color: var(--text-muted); }
        .data-card-status.ready { background: var(--accent-success-dim); color: var(--accent-success); }
        .data-card-value { font-family: var(--font-mono); font-size: 14px; color: var(--text-secondary); }
        .mood-section { margin-bottom: 16px; }
        .mood-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-tertiary); margin-bottom: 10px; }
        .mood-grid { display: flex; gap: 8px; }
        .mood-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 12px 8px; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            cursor: pointer; transition: all 0.15s;
        }
        .mood-btn:hover { border-color: var(--border-default); background: var(--bg-tertiary); }
        .mood-btn.selected { border-color: var(--accent-primary); background: var(--accent-primary-dim); }
        .mood-emoji { font-size: 24px; }
        .mood-text { font-size: 10px; font-weight: 500; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }
        .mood-btn.selected .mood-text { color: var(--accent-primary); }
        .action-bar {
            padding: 20px; border-top: 1px solid var(--border-subtle);
            background: var(--bg-secondary); display: flex; gap: 12px;
        }
        .btn {
            flex: 1; padding: 16px 24px; font-size: 15px; font-weight: 600;
            border: none; border-radius: var(--radius-md); cursor: pointer;
            transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--accent-primary); color: var(--bg-primary); }
        .btn-primary:hover { background: #06b6d4; box-shadow: 0 0 30px rgba(34, 211, 238, 0.3); }
        .btn-primary:disabled { background: var(--bg-tertiary); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); }
        .btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }
        .btn-danger { background: var(--accent-danger-dim); color: var(--accent-danger); }
        .btn-danger:hover { background: var(--accent-danger); color: white; }
        .btn-stop { background: var(--accent-danger); color: white; }
        .btn-stop:hover { background: #ef4444; }
        .project-card {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg); padding: 20px; margin-bottom: 12px;
            cursor: pointer; transition: all 0.15s;
        }
        .project-card:hover { border-color: var(--border-default); transform: translateY(-1px); box-shadow: var(--shadow-card); }
        .project-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
        .project-name { font-size: 17px; font-weight: 600; color: var(--text-primary); }
        .project-meta { font-size: 13px; color: var(--text-tertiary); }
        .project-stats { display: flex; gap: 16px; }
        .stat { display: flex; flex-direction: column; }
        .stat-value { font-family: var(--font-mono); font-size: 20px; font-weight: 600; color: var(--accent-primary); }
        .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .sample-item {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md); padding: 16px; margin-bottom: 8px;
        }
        .sample-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .sample-id { font-family: var(--font-mono); font-size: 12px; color: var(--text-tertiary); }
        .sample-duration { font-family: var(--font-mono); font-size: 16px; font-weight: 600; color: var(--accent-primary); }
        .sample-route { font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 4px; }
        .sample-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; color: var(--text-tertiary); }
        .sample-meta-item { display: flex; align-items: center; gap: 4px; }
        .sample-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle); }
        .sample-btn {
            padding: 6px 12px; font-size: 12px; font-weight: 500;
            background: var(--bg-tertiary); border: none;
            color: var(--text-secondary); border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.15s;
        }
        .sample-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .sample-btn.danger:hover { background: var(--accent-danger-dim); color: var(--accent-danger); }
        .settings-section { margin-bottom: 24px; }
        .settings-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-tertiary); margin-bottom: 12px; }
        .settings-item {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md); padding: 14px 16px; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .settings-item-info { flex: 1; }
        .settings-item-label { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .settings-item-desc { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
        .toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-track {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-tertiary); border-radius: 12px; transition: 0.2s;
        }
        .toggle-track:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background: var(--text-muted);
            border-radius: 50%; transition: 0.2s;
        }
        .toggle input:checked + .toggle-track { background: var(--accent-primary); }
        .toggle input:checked + .toggle-track:before { background: white; transform: translateX(20px); }
        .input {
            width: 100%; padding: 12px 14px; font-size: 14px;
            font-family: var(--font-sans); background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle); color: var(--text-primary);
            border-radius: var(--radius-md); transition: all 0.15s;
        }
        .input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-primary-dim); }
        .input::placeholder { color: var(--text-muted); }
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .select {
            width: 100%; padding: 12px 14px; font-size: 14px;
            font-family: var(--font-sans); background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle); color: var(--text-primary);
            border-radius: var(--radius-md); cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center;
        }
        .select:focus { outline: none; border-color: var(--accent-primary); }
        .geofence-item { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 14px; margin-bottom: 8px; }
        .geofence-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .geofence-name { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .geofence-coords { font-family: var(--font-mono); font-size: 12px; color: var(--text-tertiary); }
        .geofence-btn {
            padding: 6px 10px; font-size: 11px; font-weight: 500;
            background: var(--accent-primary-dim); border: none;
            color: var(--accent-primary); border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.15s;
        }
        .geofence-btn:hover { background: var(--accent-primary); color: var(--bg-primary); }
        .empty-state { text-align: center; padding: 48px 24px; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-title { font-size: 17px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .empty-desc { font-size: 14px; color: var(--text-tertiary); margin-bottom: 24px; }
        .toast {
            position: fixed; bottom: 100px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            padding: 12px 20px; background: var(--bg-elevated);
            border: 1px solid var(--border-default); border-radius: var(--radius-md);
            font-size: 14px; font-weight: 500; color: var(--text-primary);
            box-shadow: var(--shadow-card); opacity: 0; transition: all 0.3s;
            z-index: 1000; max-width: 90%;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: var(--accent-success); color: var(--accent-success); }
        .toast.error { border-color: var(--accent-danger); color: var(--accent-danger); }
        .toast.warning { border-color: var(--accent-warning); color: var(--accent-warning); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); display: none;
            align-items: center; justify-content: center;
            padding: 20px; z-index: 100;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: var(--radius-lg); width: 100%; max-width: 360px; padding: 24px;
        }
        .modal-title { font-size: 17px; font-weight: 600; margin-bottom: 8px; }
        .modal-desc { font-size: 14px; color: var(--text-tertiary); margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 12px; }
        .modal-actions .btn { padding: 12px 20px; }
        .route-option {
            display: flex; align-items: center; gap: 12px; padding: 14px;
            background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md); margin-bottom: 8px;
            cursor: pointer; transition: all 0.15s;
        }
        .route-option:hover { border-color: var(--border-default); }
        .route-option.selected { border-color: var(--accent-primary); background: var(--accent-primary-dim); }
        .route-option-text { flex: 1; font-size: 14px; font-weight: 500; }
        .route-option-check {
            width: 20px; height: 20px; border: 2px solid var(--border-default);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .route-option.selected .route-option-check { border-color: var(--accent-primary); background: var(--accent-primary); }
        .route-option.selected .route-option-check::after { content: "‚úì"; color: var(--bg-primary); font-size: 12px; font-weight: bold; }
        .mt-auto { margin-top: auto; }
        .discard-warning {
            background: var(--accent-warning-dim); border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: var(--radius-md); padding: 12px 16px; margin-bottom: 16px;
            display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--accent-warning);
        }
        @media (max-width: 380px) {
            .timer-value { font-size: 52px; }
            .mood-btn { padding: 10px 6px; }
            .mood-emoji { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Home Screen -->
        <div id="screen-home" class="screen active">
            <div class="header">
                <div class="header-title">Sample Recorder</div>
                <button class="header-action" onclick="showScreen('settings')">‚öôÔ∏è</button>
            </div>
            <div class="content">
                <div id="project-list"></div>
                <button class="btn btn-secondary" style="width: 100%;" onclick="showScreen('create-project')">+ New Project</button>
            </div>
        </div>

        <!-- Recording Screen -->
        <div id="screen-recording" class="screen">
            <div class="header">
                <button class="header-back" onclick="handleRecordingBack()">‚Üê</button>
                <div class="header-title" id="recording-project-name">Project</div>
            </div>
            <div class="recording-container">
                <div class="recording-status">
                    <div class="status-indicator recording" id="status-indicator">
                        <span class="status-dot"></span>
                        <span id="status-text">RECORDING</span>
                    </div>
                </div>
                <div class="timer-display">
                    <div class="timer-value recording" id="timer-display">00:00</div>
                    <div class="timer-subtitle" id="timer-start-time">Started at --:--</div>
                </div>
                <div class="discard-warning" id="discard-warning" style="display: none;">
                    <span>‚ö†Ô∏è</span>
                    <span>Samples under 40s are auto-discarded unless explicitly saved</span>
                </div>
                <div class="route-section" id="route-section">
                    <div class="route-header">
                        <span class="route-label">Inferred Route</span>
                        <span class="route-confidence" id="route-confidence">
                            <span id="confidence-text">Detecting...</span>
                        </span>
                    </div>
                    <div class="route-display">
                        <div class="route-point">
                            <div class="route-icon" id="route-from-icon">‚ùì</div>
                            <span class="route-name" id="route-from-name">Unknown</span>
                        </div>
                        <div class="route-arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </div>
                        <div class="route-point">
                            <div class="route-icon" id="route-to-icon">‚ùì</div>
                            <span class="route-name" id="route-to-name">Unknown</span>
                        </div>
                    </div>
                    <div class="route-override">
                        <button class="route-override-btn" onclick="showRouteSelector()">Override Route</button>
                    </div>
                </div>
                <div class="data-card" id="location-card">
                    <div class="data-card-header">
                        <span class="data-card-title">üìç Location</span>
                        <span class="data-card-status pending" id="location-status">Pending</span>
                    </div>
                    <div class="data-card-value" id="location-value">Waiting for GPS...</div>
                </div>
                <div class="mood-section" id="mood-section" style="display: none;">
                    <div class="mood-label">How was this trip? (Optional)</div>
                    <div class="mood-grid">
                        <button class="mood-btn" data-mood="great" onclick="selectMood('great')"><span class="mood-emoji">üòä</span><span class="mood-text">Great</span></button>
                        <button class="mood-btn" data-mood="good" onclick="selectMood('good')"><span class="mood-emoji">üôÇ</span><span class="mood-text">Good</span></button>
                        <button class="mood-btn" data-mood="okay" onclick="selectMood('okay')"><span class="mood-emoji">üòê</span><span class="mood-text">Okay</span></button>
                        <button class="mood-btn" data-mood="bad" onclick="selectMood('bad')"><span class="mood-emoji">üòï</span><span class="mood-text">Bad</span></button>
                        <button class="mood-btn" data-mood="terrible" onclick="selectMood('terrible')"><span class="mood-emoji">üò´</span><span class="mood-text">Awful</span></button>
                    </div>
                </div>
                <div class="mt-auto"></div>
            </div>
            <div class="action-bar" id="recording-actions">
                <button class="btn btn-stop" onclick="stopRecording()">‚ñ† Stop Recording</button>
            </div>
            <div class="action-bar" id="stopped-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="discardSample()">Discard</button>
                <button class="btn btn-primary" onclick="saveSample()">Save Sample</button>
            </div>
        </div>

        <!-- Project Detail Screen -->
        <div id="screen-project-detail" class="screen">
            <div class="header">
                <button class="header-back" onclick="showScreen('home')">‚Üê</button>
                <div class="header-title" id="project-detail-title">Project</div>
            </div>
            <div class="content">
                <div id="project-stats-container"></div>
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="startNewSample()">‚ñ∂ Start New Sample</button>
                </div>
                <div class="settings-title">Recent Samples</div>
                <div id="samples-list"></div>
            </div>
            <div class="action-bar">
                <button class="btn btn-secondary" onclick="exportProjectData()">üì• CSV</button>
                <button class="btn btn-secondary" onclick="exportProjectJSON()">üì• JSON</button>
            </div>
        </div>

        <!-- Create Project Screen -->
        <div id="screen-create-project" class="screen">
            <div class="header">
                <button class="header-back" onclick="showScreen('home')">‚Üê</button>
                <div class="header-title">New Project</div>
            </div>
            <div class="content">
                <div class="input-group">
                    <label class="input-label">Project Name</label>
                    <input type="text" class="input" id="new-project-name" placeholder="e.g., Daily Commute">
                </div>
                <div class="settings-section">
                    <div class="settings-title">Data Sources</div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Location Tracking</div>
                            <div class="settings-item-desc">Record start/end GPS coordinates</div>
                        </div>
                        <label class="toggle"><input type="checkbox" id="new-project-location" checked><span class="toggle-track"></span></label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Weather Data</div>
                            <div class="settings-item-desc">Fetch weather when sample is saved</div>
                        </div>
                        <label class="toggle"><input type="checkbox" id="new-project-weather"><span class="toggle-track"></span></label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-label">Route Inference</div>
                            <div class="settings-item-desc">Auto-detect route from geofences</div>
                        </div>
                        <label class="toggle"><input type="checkbox" id="new-project-route" checked><span class="toggle-track"></span></label>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="createProject()">Create Project</button>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="screen-settings" class="screen">
            <div class="header">
                <button class="header-back" onclick="showScreen('home')">‚Üê</button>
                <div class="header-title">Settings</div>
            </div>
            <div class="content">
                <div class="settings-section">
                    <div class="settings-title">Geofences</div>
                    <div id="geofence-list"></div>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="addGeofence()">+ Add Geofence</button>
                </div>
                <div class="settings-section">
                    <div class="settings-title">API Keys</div>
                    <div class="input-group">
                        <label class="input-label">OpenWeatherMap API Key</label>
                        <input type="text" class="input" id="settings-weather-key" placeholder="Enter API key">
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 6px;">Get free key at openweathermap.org</div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Data</div>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="exportAllData()">üì• Export All Data</button>
                    <button class="btn btn-danger" style="width: 100%;" onclick="confirmClearData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
        </div>

        <!-- Edit Sample Screen -->
        <div id="screen-edit-sample" class="screen">
            <div class="header">
                <button class="header-back" onclick="showScreen('project-detail')">‚Üê</button>
                <div class="header-title">Edit Sample</div>
            </div>
            <div class="content">
                <div class="input-group">
                    <label class="input-label">Route</label>
                    <select class="select" id="edit-sample-route"></select>
                </div>
                <div class="mood-section">
                    <div class="mood-label">Mood</div>
                    <div class="mood-grid" id="edit-mood-grid"></div>
                </div>
                <div class="data-card">
                    <div class="data-card-header"><span class="data-card-title">Sample Data (Read-only)</span></div>
                    <div id="edit-sample-data"></div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="saveEditedSample()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Route Selector Modal -->
    <div id="modal-route" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">Select Route</div>
            <div class="modal-desc">Override the auto-detected route</div>
            <div id="route-options"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeRouteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRouteSelection()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Geofence Modal -->
    <div id="modal-geofence" class="modal-overlay">
        <div class="modal">
            <div class="modal-title" id="geofence-modal-title">Add Geofence</div>
            <div class="input-group"><label class="input-label">Name</label><input type="text" class="input" id="geofence-name" placeholder="e.g., Home, Office"></div>
            <div class="input-group"><label class="input-label">Icon</label>
                <select class="select" id="geofence-icon">
                    <option value="üè†">üè† Home</option><option value="üè¢">üè¢ Office</option><option value="üöâ">üöâ Station</option>
                    <option value="üè´">üè´ School</option><option value="üè™">üè™ Store</option><option value="üìç">üìç Other</option>
                </select>
            </div>
            <div class="input-group"><label class="input-label">Latitude</label><input type="number" step="any" class="input" id="geofence-lat" placeholder="35.6762"></div>
            <div class="input-group"><label class="input-label">Longitude</label><input type="number" step="any" class="input" id="geofence-lng" placeholder="139.6503"></div>
            <div class="input-group"><label class="input-label">Radius (meters)</label><input type="number" class="input" id="geofence-radius" value="200"></div>
            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 12px;" onclick="useCurrentLocation()">üìç Use Current Location</button>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeGeofenceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveGeofence()">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal">
            <div class="modal-title" id="confirm-title">Confirm</div>
            <div class="modal-desc" id="confirm-desc">Are you sure?</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-danger" onclick="executeConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    // ============= STORAGE =============
    const STORAGE_KEY = 'sample_recorder_v2';
    const SETTINGS_KEY = 'sample_recorder_settings';

    let state = {
        currentProjectId: null,
        currentSampleId: null,
        editingGeofenceId: null,
        recording: { active: false, startTime: null, startLocation: null, endLocation: null, inferredRoute: null, selectedMood: null, timerInterval: null },
        tempRouteSelection: null,
        confirmCallback: null
    };

    function loadData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
        return initializeDefaultData();
    }

    function saveData(data) {
        data.updated_at = new Date().toISOString();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadSettings() {
        const raw = localStorage.getItem(SETTINGS_KEY);
        return raw ? JSON.parse(raw) : { weather_api_key: null };
    }

    function saveSettings(settings) {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function initializeDefaultData() {
        const data = {
            projects: [{ id: generateId(), name: 'Daily Commute', created_at: new Date().toISOString(), config: { location_enabled: true, weather_enabled: true, route_inference_enabled: true } }],
            samples: [],
            geofences: [
                { id: generateId(), name: 'Home', icon: 'üè†', latitude: 35.6812, longitude: 139.7671, radius_meters: 200, created_at: new Date().toISOString() },
                { id: generateId(), name: 'Station', icon: 'üöâ', latitude: 35.6580, longitude: 139.7016, radius_meters: 150, created_at: new Date().toISOString() },
                { id: generateId(), name: 'Office', icon: 'üè¢', latitude: 35.6762, longitude: 139.6503, radius_meters: 200, created_at: new Date().toISOString() }
            ],
            created_at: new Date().toISOString()
        };
        saveData(data);
        return data;
    }

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }

    // ============= ROUTE INFERENCE =============
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function findNearestGeofence(location, geofences) {
        if (!location || !geofences.length) return null;
        let nearest = null, minDist = Infinity;
        for (const gf of geofences) {
            const d = calculateDistance(location.latitude, location.longitude, gf.latitude, gf.longitude);
            if (d < minDist) { minDist = d; nearest = { geofence: gf, distance: d }; }
        }
        return nearest;
    }

    function inferRoute(startLoc, endLoc) {
        const data = loadData();
        const gfs = data.geofences;
        if (!startLoc || !gfs.length) return { from: null, to: null, confidence: 'low' };
        
        const sn = findNearestGeofence(startLoc, gfs);
        const en = endLoc ? findNearestGeofence(endLoc, gfs) : null;
        let from = null, to = null, conf = 'low';
        
        if (sn && sn.distance <= sn.geofence.radius_meters) { from = sn.geofence; conf = 'medium'; }
        else if (sn && sn.distance <= sn.geofence.radius_meters * 2) { from = sn.geofence; }
        
        if (en && en.distance <= en.geofence.radius_meters) { to = en.geofence; conf = from && conf === 'medium' ? 'high' : 'medium'; }
        else if (en && en.distance <= en.geofence.radius_meters * 2) { to = en.geofence; }
        
        return { from, to, confidence: conf };
    }

    function getPossibleRoutes() {
        const gfs = loadData().geofences;
        const routes = [];
        for (let i = 0; i < gfs.length; i++) {
            for (let j = 0; j < gfs.length; j++) {
                if (i !== j) routes.push({ from: gfs[i], to: gfs[j], label: `${gfs[i].name} ‚Üí ${gfs[j].name}` });
            }
        }
        return routes;
    }

    // ============= WEATHER API =============
    async function fetchWeather(location) {
        const settings = loadSettings();
        if (!settings.weather_api_key) return { fetched_at: new Date().toISOString(), condition: 'No API Key', temperature_c: null, humidity_percent: null, is_mock: true };
        try {
            const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${location.latitude}&lon=${location.longitude}&appid=${settings.weather_api_key}&units=metric`);
            const d = await r.json();
            if (d.cod === 200) return { fetched_at: new Date().toISOString(), condition: d.weather[0].main, temperature_c: d.main.temp, humidity_percent: d.main.humidity, wind_speed_ms: d.wind.speed, is_mock: false };
        } catch (e) { console.error(e); }
        return { fetched_at: new Date().toISOString(), condition: 'Fetch Failed', temperature_c: null, is_mock: true };
    }

    // ============= LOCATION =============
    function getCurrentLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
            navigator.geolocation.getCurrentPosition(
                p => resolve({ latitude: p.coords.latitude, longitude: p.coords.longitude, accuracy: p.coords.accuracy, timestamp: new Date().toISOString() }),
                e => reject(e),
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });
    }

    // ============= NAVIGATION =============
    function showScreen(name) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${name}`).classList.add('active');
        if (name === 'home') renderProjectList();
        else if (name === 'project-detail') renderProjectDetail();
        else if (name === 'settings') renderSettings();
    }

    // ============= HOME =============
    function renderProjectList() {
        const data = loadData();
        const c = document.getElementById('project-list');
        if (!data.projects.length) { c.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-title">No Projects</div><div class="empty-desc">Create your first project</div></div>'; return; }
        c.innerHTML = data.projects.map(p => {
            const samples = data.samples.filter(s => s.project_id === p.id);
            const avg = samples.length ? Math.round(samples.reduce((sum, s) => sum + s.duration_seconds, 0) / samples.length) : 0;
            return `<div class="project-card" onclick="openProject('${p.id}')"><div class="project-card-header"><div><div class="project-name">${escapeHtml(p.name)}</div><div class="project-meta">${p.config.location_enabled ? 'üìç' : ''} ${p.config.weather_enabled ? 'üå§Ô∏è' : ''} ${p.config.route_inference_enabled ? 'üó∫Ô∏è' : ''}</div></div></div><div class="project-stats"><div class="stat"><div class="stat-value">${samples.length}</div><div class="stat-label">Samples</div></div><div class="stat"><div class="stat-value">${formatDurationShort(avg)}</div><div class="stat-label">Avg</div></div></div></div>`;
        }).join('');
    }

    function openProject(id) { state.currentProjectId = id; showScreen('project-detail'); }

    // ============= PROJECT DETAIL =============
    function renderProjectDetail() {
        const data = loadData();
        const p = data.projects.find(x => x.id === state.currentProjectId);
        if (!p) return showScreen('home');
        document.getElementById('project-detail-title').textContent = p.name;
        const samples = data.samples.filter(s => s.project_id === p.id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        const avg = samples.length ? Math.round(samples.reduce((sum, s) => sum + s.duration_seconds, 0) / samples.length) : 0;
        const min = samples.length ? Math.min(...samples.map(s => s.duration_seconds)) : 0;
        const max = samples.length ? Math.max(...samples.map(s => s.duration_seconds)) : 0;
        document.getElementById('project-stats-container').innerHTML = `<div class="data-card"><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;text-align:center;"><div><div style="font-family:var(--font-mono);font-size:24px;font-weight:600;color:var(--accent-primary);">${samples.length}</div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Samples</div></div><div><div style="font-family:var(--font-mono);font-size:24px;font-weight:600;">${formatDurationShort(avg)}</div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Average</div></div><div><div style="font-family:var(--font-mono);font-size:24px;font-weight:600;color:var(--text-secondary);">${formatDurationShort(min)}-${formatDurationShort(max)}</div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Range</div></div></div></div>`;
        
        const list = document.getElementById('samples-list');
        if (!samples.length) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-title">No Samples</div></div>'; return; }
        list.innerHTML = samples.slice(0, 50).map(s => {
            const fromGf = data.geofences.find(g => g.id === s.route?.from_geofence_id);
            const toGf = data.geofences.find(g => g.id === s.route?.to_geofence_id);
            const route = fromGf && toGf ? `${fromGf.icon} ${fromGf.name} ‚Üí ${toGf.icon} ${toGf.name}` : 'Unknown Route';
            const d = new Date(s.created_at);
            const mood = { great: 'üòä', good: 'üôÇ', okay: 'üòê', bad: 'üòï', terrible: 'üò´' }[s.mood] || '';
            return `<div class="sample-item"><div class="sample-header"><span class="sample-id">#${s.id.slice(-6).toUpperCase()}</span><span class="sample-duration">${formatDuration(s.duration_seconds)}</span></div><div class="sample-route">${route}</div><div class="sample-meta"><span class="sample-meta-item">üìÖ ${d.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span><span class="sample-meta-item">üïê ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</span>${mood?`<span class="sample-meta-item">${mood}</span>`:''}${s.weather_snapshot?.temperature_c!=null?`<span class="sample-meta-item">üå°Ô∏è ${s.weather_snapshot.temperature_c}¬∞C</span>`:''}</div><div class="sample-actions"><button class="sample-btn" onclick="editSample('${s.id}')">Edit</button><button class="sample-btn danger" onclick="confirmDeleteSample('${s.id}')">Delete</button></div></div>`;
        }).join('');
    }

    // ============= RECORDING =============
    async function startNewSample() {
        const data = loadData();
        const p = data.projects.find(x => x.id === state.currentProjectId);
        if (!p) return showToast('Project not found', 'error');
        
        state.recording = { active: true, startTime: new Date(), startLocation: null, endLocation: null, inferredRoute: null, selectedMood: null, timerInterval: null };
        showScreen('recording');
        document.getElementById('recording-project-name').textContent = p.name;
        document.getElementById('status-indicator').className = 'status-indicator recording';
        document.getElementById('status-text').textContent = 'RECORDING';
        document.getElementById('timer-display').className = 'timer-value recording';
        document.getElementById('timer-display').textContent = '00:00';
        document.getElementById('timer-start-time').textContent = `Started at ${formatTime(state.recording.startTime)}`;
        document.getElementById('recording-actions').style.display = 'flex';
        document.getElementById('stopped-actions').style.display = 'none';
        document.getElementById('mood-section').style.display = 'none';
        document.getElementById('discard-warning').style.display = 'none';
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('route-section').style.display = p.config.route_inference_enabled ? 'block' : 'none';
        document.getElementById('location-card').style.display = p.config.location_enabled ? 'block' : 'none';
        document.getElementById('route-from-icon').textContent = '‚ùì';
        document.getElementById('route-from-name').textContent = 'Unknown';
        document.getElementById('route-to-icon').textContent = '‚ùì';
        document.getElementById('route-to-name').textContent = 'Unknown';
        document.getElementById('confidence-text').textContent = 'Detecting...';
        
        state.recording.timerInterval = setInterval(updateTimer, 1000);
        
        if (p.config.location_enabled) {
            document.getElementById('location-status').textContent = 'Acquiring...';
            document.getElementById('location-status').className = 'data-card-status pending';
            document.getElementById('location-value').textContent = 'Waiting for GPS...';
            try {
                const loc = await getCurrentLocation();
                state.recording.startLocation = loc;
                document.getElementById('location-status').textContent = 'Acquired';
                document.getElementById('location-status').className = 'data-card-status ready';
                document.getElementById('location-value').textContent = `${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)} (¬±${Math.round(loc.accuracy)}m)`;
                if (p.config.route_inference_enabled) updateRouteInference();
            } catch (e) {
                document.getElementById('location-status').textContent = 'Failed';
                document.getElementById('location-value').textContent = e.message;
            }
        }
    }

    function updateTimer() {
        if (!state.recording.active) return;
        const elapsed = Math.floor((new Date() - state.recording.startTime) / 1000);
        document.getElementById('timer-display').textContent = formatDuration(elapsed);
        document.getElementById('discard-warning').style.display = elapsed < 40 ? 'flex' : 'none';
    }

    async function stopRecording() {
        if (!state.recording.active) return;
        state.recording.active = false;
        clearInterval(state.recording.timerInterval);
        
        document.getElementById('status-indicator').className = 'status-indicator stopped';
        document.getElementById('status-text').textContent = 'STOPPED';
        document.getElementById('timer-display').className = 'timer-value';
        document.getElementById('recording-actions').style.display = 'none';
        document.getElementById('stopped-actions').style.display = 'flex';
        document.getElementById('mood-section').style.display = 'block';
        
        const data = loadData();
        const p = data.projects.find(x => x.id === state.currentProjectId);
        if (p.config.location_enabled) {
            try {
                state.recording.endLocation = await getCurrentLocation();
                if (p.config.route_inference_enabled) updateRouteInference();
            } catch (e) { console.error(e); }
        }
    }

    function updateRouteInference() {
        const inf = inferRoute(state.recording.startLocation, state.recording.endLocation);
        state.recording.inferredRoute = inf;
        const confEl = document.getElementById('route-confidence');
        const confText = document.getElementById('confidence-text');
        confEl.style.color = inf.confidence === 'high' ? 'var(--accent-success)' : inf.confidence === 'medium' ? 'var(--accent-warning)' : 'var(--accent-danger)';
        confText.textContent = inf.confidence.charAt(0).toUpperCase() + inf.confidence.slice(1) + ' confidence';
        document.getElementById('route-from-icon').textContent = inf.from?.icon || '‚ùì';
        document.getElementById('route-from-name').textContent = inf.from?.name || 'Unknown';
        document.getElementById('route-to-icon').textContent = inf.to?.icon || '‚ùì';
        document.getElementById('route-to-name').textContent = inf.to?.name || 'Unknown';
    }

    function selectMood(m) {
        state.recording.selectedMood = m;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.toggle('selected', b.dataset.mood === m));
    }

    async function saveSample() {
        const endTime = new Date();
        const duration = Math.floor((endTime - state.recording.startTime) / 1000);
        if (duration < 40) {
            showConfirmModal('Save Short Sample?', `This sample is only ${duration}s. Save anyway?`, () => finalizeSave(endTime, duration));
            return;
        }
        await finalizeSave(endTime, duration);
    }

    async function finalizeSave(endTime, duration) {
        const data = loadData();
        const p = data.projects.find(x => x.id === state.currentProjectId);
        let weather = null;
        if (p.config.weather_enabled && state.recording.endLocation) weather = await fetchWeather(state.recording.endLocation);
        
        const sample = {
            id: generateId(),
            project_id: state.currentProjectId,
            start_time: state.recording.startTime.toISOString(),
            end_time: endTime.toISOString(),
            duration_seconds: duration,
            start_location: state.recording.startLocation,
            end_location: state.recording.endLocation,
            route: state.recording.inferredRoute ? { from_geofence_id: state.recording.inferredRoute.from?.id || null, to_geofence_id: state.recording.inferredRoute.to?.id || null, inference_confidence: state.recording.inferredRoute.confidence, inferred_at: new Date().toISOString() } : null,
            mood: state.recording.selectedMood,
            weather_snapshot: weather,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        data.samples.push(sample);
        saveData(data);
        showToast('Sample saved', 'success');
        showScreen('project-detail');
    }

    function discardSample() {
        showConfirmModal('Discard Sample?', 'This sample will not be saved.', () => {
            clearInterval(state.recording.timerInterval);
            state.recording = { active: false, startTime: null, startLocation: null, endLocation: null, inferredRoute: null, selectedMood: null, timerInterval: null };
            showScreen('project-detail');
            showToast('Sample discarded', 'warning');
        });
    }

    function handleRecordingBack() {
        if (state.recording.active) showConfirmModal('Stop Recording?', 'Going back will stop recording.', stopRecording);
        else discardSample();
    }

    // ============= ROUTE SELECTOR =============
    function showRouteSelector() {
        const routes = getPossibleRoutes();
        state.tempRouteSelection = state.recording.inferredRoute ? { from: state.recording.inferredRoute.from, to: state.recording.inferredRoute.to } : null;
        document.getElementById('route-options').innerHTML = routes.map(r => {
            const sel = state.tempRouteSelection && state.tempRouteSelection.from?.id === r.from.id && state.tempRouteSelection.to?.id === r.to.id;
            return `<div class="route-option ${sel?'selected':''}" onclick="selectRoute('${r.from.id}','${r.to.id}')" data-from="${r.from.id}" data-to="${r.to.id}"><span>${r.from.icon} ‚Üí ${r.to.icon}</span><span class="route-option-text">${r.label}</span><span class="route-option-check"></span></div>`;
        }).join('');
        document.getElementById('modal-route').classList.add('show');
    }

    function selectRoute(fromId, toId) {
        const data = loadData();
        state.tempRouteSelection = { from: data.geofences.find(g => g.id === fromId), to: data.geofences.find(g => g.id === toId) };
        document.querySelectorAll('.route-option').forEach(el => el.classList.toggle('selected', el.dataset.from === fromId && el.dataset.to === toId));
    }

    function confirmRouteSelection() {
        if (state.tempRouteSelection) {
            state.recording.inferredRoute = { from: state.tempRouteSelection.from, to: state.tempRouteSelection.to, confidence: 'manual' };
            updateRouteInference();
            document.getElementById('route-confidence').style.color = 'var(--accent-primary)';
            document.getElementById('confidence-text').textContent = 'Manual';
        }
        closeRouteModal();
    }

    function closeRouteModal() { document.getElementById('modal-route').classList.remove('show'); }

    // ============= EDIT SAMPLE =============
    function editSample(id) {
        const data = loadData();
        const s = data.samples.find(x => x.id === id);
        if (!s) return showToast('Sample not found', 'error');
        state.currentSampleId = id;
        const routes = getPossibleRoutes();
        document.getElementById('edit-sample-route').innerHTML = '<option value="">Unknown Route</option>' + routes.map(r => `<option value="${r.from.id}|${r.to.id}" ${s.route?.from_geofence_id===r.from.id && s.route?.to_geofence_id===r.to.id?'selected':''}>${r.label}</option>`).join('');
        const moods = ['great','good','okay','bad','terrible'];
        const moodLabels = {great:'üòä Great',good:'üôÇ Good',okay:'üòê Okay',bad:'üòï Bad',terrible:'üò´ Awful'};
        document.getElementById('edit-mood-grid').innerHTML = moods.map(m => `<button class="mood-btn ${s.mood===m?'selected':''}" data-mood="${m}" onclick="selectEditMood('${m}')"><span class="mood-emoji">${moodLabels[m].split(' ')[0]}</span><span class="mood-text">${moodLabels[m].split(' ')[1]}</span></button>`).join('');
        const d = new Date(s.created_at);
        document.getElementById('edit-sample-data').innerHTML = `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-subtle);"><span style="color:var(--text-tertiary);">Duration</span><span style="font-family:var(--font-mono);">${formatDuration(s.duration_seconds)}</span></div><div style="display:flex;justify-content:space-between;padding:8px 0;"><span style="color:var(--text-tertiary);">Date</span><span>${d.toLocaleDateString()} ${d.toLocaleTimeString()}</span></div>`;
        showScreen('edit-sample');
    }

    function selectEditMood(m) { document.querySelectorAll('#edit-mood-grid .mood-btn').forEach(b => b.classList.toggle('selected', b.dataset.mood === m)); }

    function saveEditedSample() {
        const data = loadData();
        const s = data.samples.find(x => x.id === state.currentSampleId);
        if (!s) return;
        const rv = document.getElementById('edit-sample-route').value;
        if (rv) { const [from, to] = rv.split('|'); s.route = { from_geofence_id: from, to_geofence_id: to, inference_confidence: 'manual', inferred_at: new Date().toISOString() }; }
        else s.route = null;
        const selMood = document.querySelector('#edit-mood-grid .mood-btn.selected');
        s.mood = selMood ? selMood.dataset.mood : null;
        s.updated_at = new Date().toISOString();
        saveData(data);
        showToast('Sample updated', 'success');
        showScreen('project-detail');
    }

    function confirmDeleteSample(id) {
        showConfirmModal('Delete Sample?', 'This cannot be undone.', () => {
            const data = loadData();
            data.samples = data.samples.filter(s => s.id !== id);
            saveData(data);
            showToast('Sample deleted', 'success');
            renderProjectDetail();
        });
    }

    // ============= CREATE PROJECT =============
    function createProject() {
        const name = document.getElementById('new-project-name').value.trim();
        if (!name) return showToast('Enter a project name', 'error');
        const data = loadData();
        const p = { id: generateId(), name, created_at: new Date().toISOString(), config: { location_enabled: document.getElementById('new-project-location').checked, weather_enabled: document.getElementById('new-project-weather').checked, route_inference_enabled: document.getElementById('new-project-route').checked } };
        data.projects.push(p);
        saveData(data);
        document.getElementById('new-project-name').value = '';
        showToast('Project created', 'success');
        state.currentProjectId = p.id;
        showScreen('project-detail');
    }

    // ============= SETTINGS =============
    function renderSettings() {
        const data = loadData();
        const settings = loadSettings();
        document.getElementById('geofence-list').innerHTML = data.geofences.map(g => `<div class="geofence-item"><div class="geofence-header"><span class="geofence-name">${g.icon} ${g.name}</span><button class="geofence-btn" onclick="editGeofence('${g.id}')">Edit</button></div><div class="geofence-coords">${g.latitude.toFixed(5)}, ${g.longitude.toFixed(5)} (${g.radius_meters}m)</div></div>`).join('');
        document.getElementById('settings-weather-key').value = settings.weather_api_key || '';
        document.getElementById('settings-weather-key').onchange = e => { const s = loadSettings(); s.weather_api_key = e.target.value || null; saveSettings(s); showToast('API key saved', 'success'); };
    }

    function addGeofence() {
        state.editingGeofenceId = null;
        document.getElementById('geofence-modal-title').textContent = 'Add Geofence';
        document.getElementById('geofence-name').value = '';
        document.getElementById('geofence-icon').value = 'üìç';
        document.getElementById('geofence-lat').value = '';
        document.getElementById('geofence-lng').value = '';
        document.getElementById('geofence-radius').value = '200';
        document.getElementById('modal-geofence').classList.add('show');
    }

    function editGeofence(id) {
        const g = loadData().geofences.find(x => x.id === id);
        if (!g) return;
        state.editingGeofenceId = id;
        document.getElementById('geofence-modal-title').textContent = 'Edit Geofence';
        document.getElementById('geofence-name').value = g.name;
        document.getElementById('geofence-icon').value = g.icon;
        document.getElementById('geofence-lat').value = g.latitude;
        document.getElementById('geofence-lng').value = g.longitude;
        document.getElementById('geofence-radius').value = g.radius_meters;
        document.getElementById('modal-geofence').classList.add('show');
    }

    async function useCurrentLocation() {
        try {
            const loc = await getCurrentLocation();
            document.getElementById('geofence-lat').value = loc.latitude;
            document.getElementById('geofence-lng').value = loc.longitude;
            showToast('Location captured', 'success');
        } catch (e) { showToast('Failed: ' + e.message, 'error'); }
    }

    function saveGeofence() {
        const name = document.getElementById('geofence-name').value.trim();
        const icon = document.getElementById('geofence-icon').value;
        const lat = parseFloat(document.getElementById('geofence-lat').value);
        const lng = parseFloat(document.getElementById('geofence-lng').value);
        const radius = parseInt(document.getElementById('geofence-radius').value);
        if (!name) return showToast('Enter a name', 'error');
        if (isNaN(lat) || isNaN(lng)) return showToast('Enter valid coordinates', 'error');
        const data = loadData();
        if (state.editingGeofenceId) {
            const g = data.geofences.find(x => x.id === state.editingGeofenceId);
            if (g) { g.name = name; g.icon = icon; g.latitude = lat; g.longitude = lng; g.radius_meters = radius; }
        } else {
            data.geofences.push({ id: generateId(), name, icon, latitude: lat, longitude: lng, radius_meters: radius, created_at: new Date().toISOString() });
        }
        saveData(data);
        closeGeofenceModal();
        renderSettings();
        showToast('Geofence saved', 'success');
    }

    function closeGeofenceModal() { document.getElementById('modal-geofence').classList.remove('show'); }

    // ============= EXPORT =============
    function exportProjectData() {
        const data = loadData();
        const p = data.projects.find(x => x.id === state.currentProjectId);
        const samples = data.samples.filter(s => s.project_id === state.currentProjectId);
        if (!samples.length) return showToast('No samples', 'error');
        const headers = ['sample_id','start_time','end_time','duration_seconds','route_from','route_to','route_confidence','mood','start_lat','start_lng','end_lat','end_lng','weather_condition','temperature_c','humidity_percent','created_at'];
        const rows = samples.map(s => {
            const fromGf = data.geofences.find(g => g.id === s.route?.from_geofence_id);
            const toGf = data.geofences.find(g => g.id === s.route?.to_geofence_id);
            return [s.id, s.start_time, s.end_time, s.duration_seconds, fromGf?.name||'', toGf?.name||'', s.route?.inference_confidence||'', s.mood||'', s.start_location?.latitude||'', s.start_location?.longitude||'', s.end_location?.latitude||'', s.end_location?.longitude||'', s.weather_snapshot?.condition||'', s.weather_snapshot?.temperature_c??'', s.weather_snapshot?.humidity_percent??'', s.created_at].map(v=>`"${v}"`).join(',');
        });
        downloadFile([headers.join(','), ...rows].join('\n'), `${p.name.replace(/\s+/g,'_')}_samples.csv`, 'text/csv');
        showToast('CSV exported', 'success');
    }

    function exportProjectJSON() {
        const data = loadData();
        const p = data.projects.find(x => x.id === state.currentProjectId);
        const samples = data.samples.filter(s => s.project_id === state.currentProjectId);
        if (!samples.length) return showToast('No samples', 'error');
        downloadFile(JSON.stringify({ project: p, geofences: data.geofences, samples }, null, 2), `${p.name.replace(/\s+/g,'_')}_samples.json`, 'application/json');
        showToast('JSON exported', 'success');
    }

    function exportAllData() {
        downloadFile(JSON.stringify(loadData(), null, 2), `sample_recorder_backup_${new Date().toISOString().slice(0,10)}.json`, 'application/json');
        showToast('Backup exported', 'success');
    }

    function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ============= CONFIRM MODAL =============
    function showConfirmModal(title, desc, cb) {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-desc').textContent = desc;
        state.confirmCallback = cb;
        document.getElementById('modal-confirm').classList.add('show');
    }

    function closeConfirmModal() { document.getElementById('modal-confirm').classList.remove('show'); state.confirmCallback = null; }
    function executeConfirm() { if (state.confirmCallback) state.confirmCallback(); closeConfirmModal(); }

    function confirmClearData() {
        showConfirmModal('Clear All Data?', 'This deletes everything permanently.', () => {
            localStorage.removeItem(STORAGE_KEY);
            initializeDefaultData();
            showScreen('home');
            showToast('All data cleared', 'warning');
        });
    }

    // ============= UTILITIES =============
    function formatDuration(s) { const m = Math.floor(s/60), sec = s%60; return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; }
    function formatDurationShort(s) { if (!s) return '--'; const m = Math.floor(s/60); return m ? `${m}m` : `${s}s`; }
    function formatTime(d) { return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); }
    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg; t.className = `toast ${type} show`;
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // ============= INIT =============
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderProjectList();
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('show'); }));
    });
    </script>
</body>
</html>
